<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{vendor/layouts/layout :: layout('Edit Product', ~{this :: .content-main})}">

<head>
	<title></title>
	<style>
		.thumbnail-container {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}
	
		.thumbnail-preview {
			width: 100px;
			height: 100px;
			object-fit: cover;
			border: 1px solid #ccc;
			border-radius: 4px;
			padding: 3px;
		}
	</style>

</head>

<body>
	<section class="content-main">
		<form method="POST" th:action="@{/vendor/product/edit}" enctype="multipart/form-data">
			<div class="row">

				<div class="col-9">
					<div class="content-header">
						<a th:href="@{/vendor/product/list}">
							<i class="material-icons md-arrow_back">
								
							</i> Go back</a>
						<br>
					</div>
					


				</div>
				<div class="col-lg-6">
					<div class="card mb-4">
						<div class="card-header">
							<h2 class="content-title">Edit Product</h2>
						</div>
						<div class="card-body">
							<div class="mb-4">
								<label class="form-label" for="product_name">Product title</label>
								<input class="form-control" id="product_name" type="text" th:field="${product.name}">
								<input class="form-control"  type="hidden" th:field="${product.id}">
								<input class="form-control"  type="hidden" name="proId" th:value=${product.id}>

							</div>


							<div class="row">
								<div class="col-lg-4">
									<div class="mb-4">
										<label class="form-label">Regular price</label>
										<div class="row gx-2"></div>
										<input class="form-control" type="number" th:field="${product.price}">
									</div>
								</div>
								<div class="col-lg-4">
									<div class="mb-4">
										<label class="form-label">Quantity</label>
										<div class="row gx-2"></div>
										<input class="form-control" type="number" th:field="${product.quantity}">
									</div>
								</div>

								<div class="col-lg-4">
									<label class="form-label">Currency</label>
									<input class="form-control" value="USD" type="text" readonly>

								</div>
								<div class="mb-4">
									<label class="form-label">Full description</label>
									<br>
									<textarea class="form-control" cols="90" rows="8"
										th:field=${product.description}></textarea>
								</div>
								<div class="mb-4">
									<label class="form-label">Category</label>
									<select class="form-select" th:field="${product.productCategories}">
										<option th:each="category: ${categories}" th:value="${category.id}"
											th:text="${category.name}"> </option>
									</select>
								</div>
							</div>



						</div>
					</div>
					<div class="card mb-4">
						<div class="card-header">
							<h4 class="mb-0">Product Variations</h4>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered table-hover align-middle">
									<thead class="table-light">
										<tr>
											<th scope="col">Attribute</th>
											<th scope="col">Value</th>
											<th scope="col" class="text-center">Action</th>
										</tr>
									</thead>
									<tbody>
										<th:block th:each="productVariant, i : ${productVariants}">
										    <tr>
										        <td th:text="${i.index == 0 || productVariants[i.index - 1].productAttributes.name != productVariant.productAttributes.name} ? ${productVariant.productAttributes.name} : ''"></td>
										        <td th:text="${productVariant.value}"></td>
										        <td class="text-center">
										            <a class="btn btn-sm btn-primary me-1" th:href="@{'/vendor/productVariant/edit/' + ${productVariant.id}}">Edit</a>
										            <a class="btn btn-sm btn-danger">Delete</button>
										        </td>
										    </tr>
										</th:block>
										<!-- Thêm dòng khác nếu cần -->
									</tbody>
								</table>
								<!-- Nút Submit -->
								<div style="float: right">
									<!-- Button trigger modal -->
									<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
										<i class="material-icons md-plus"></i>Add Variant
									</button>
									
									
								</div>
								
							</div>
						</div>
					</div>

				</div>
				<div class="col-lg-4">
					<div class="card mb-4">
						<div class="card-header">
							<h4>Media</h4>
						</div>
						<div class="card-body">
							<div class="input-upload">
								<th:block th:if="${not #lists.isEmpty(product.mediases)}">
									<!-- Ảnh cũ -->
									<div class="thumbnail-container" id="existingImagesContainer">
										<th:block th:each="media : ${product.mediases}">
											<div class="img-wrapper" th:attr="data-id=${media.id}">
												<img class="img-md img-thumbnail"
												     th:src="@{${media.name.contains('https:') ? media.name : '/assets/imgs/items/' + media.name}}"
												     alt="Media">
											</div>
										</th:block>
									</div>

									<!-- Hidden inputs chứa ID ảnh bị xóa -->
									<div id="deletedImageIdsContainer"></div>

								</th:block>
							
							
								<!-- Nếu không có ảnh -->
								<th:block th:if="${#lists.isEmpty(product.mediases)}">
									<img class="img-md img-thumbnail" th:src="@{'/assets/imgs/others/noimg.jpg'}" alt="No Image">
								</th:block>
							
								<!-- Hidden inputs để gửi ID ảnh cũ bị xoá -->
								<div id="deletedImageIdsContainer"></div>

								<!-- Ảnh mới -->
								<div class="thumbnail-container" id="newImagesContainer"></div>
								<input class="form-control mt-3" type="file" multiple id="imageInput" accept="image/*" name="files">
						</div>
					</div>
				</div>
			</div>
			<!-- Nút Submit -->
			<div>
				<button class="btn btn-primary" type="submit">Edit Product</button>
			</div>
		</form>
		
		<form>
			<!-- Modal -->
			<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="exampleModalLabel">Add Variant</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<form method="POST" th:action="@{/vendor/productVariant/add}">
								<input type="hidden" th:field="${product.id}" />
			
								<div>
									<div class="mb-4">
										<label class="form-label">Attribute</label>
										<input class="form-control" type="text" th:field="${productVariant.productAttributes.name}"
											/>
									</div>
									<div class="mb-4">
										<label class="form-label">Value</label>
										<input class="form-control" th:field="${productVariant.value}" />
									</div>
								</div>
			
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
									<button type="submit" class="btn btn-primary">Save changes</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<!-- Modal -->
>
			</div>
			<!-- Modal -->
		</form>
		
		<script>
			document.getElementById("imageInput").addEventListener("change", function (event) {
				const files = Array.from(event.target.files);
				const newContainer = document.getElementById("newImagesContainer");
				const existingContainer = document.getElementById("existingImagesContainer");
				const deletedContainer = document.getElementById("deletedImageIdsContainer");

				// Xoá tất cả ảnh cũ khỏi giao diện và tạo input hidden để gửi deleteMediaIds[]
				const oldImages = existingContainer.querySelectorAll(".img-wrapper");
				oldImages.forEach(wrapper => {
					const id = wrapper.getAttribute("data-id");
					if (id) {
						const hiddenInput = document.createElement("input");
						hiddenInput.type = "hidden";
						hiddenInput.name = "deleteMediaIds";
						hiddenInput.value = id;
						deletedContainer.appendChild(hiddenInput);
					}
					wrapper.remove(); // Xoá ảnh khỏi giao diện
				});

				// Preview ảnh mới
				newContainer.innerHTML = "";
				files.forEach(file => {
					const reader = new FileReader();
					reader.onload = function (e) {
						const wrapper = document.createElement("div");
						wrapper.classList.add("img-wrapper");

						const img = document.createElement("img");
						img.src = e.target.result;

						wrapper.appendChild(img);
						newContainer.appendChild(wrapper);
					};
					reader.readAsDataURL(file);
				});
			});
		</script>



	</section>



</body>