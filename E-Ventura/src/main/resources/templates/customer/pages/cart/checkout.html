<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{customer/layouts/layout :: layout('Product details', ~{this :: .content-main})}">

<head>
<title>DashBoard</title>
</head>

<body>
	<main class="main content-main">
		      <div class="section-box">
        <div class="breadcrumbs-div">
          <div class="container">
            <ul class="breadcrumb">
              <li><a class="font-xs color-gray-1000" href="index.html">Home</a></li>
              <li><a class="font-xs color-gray-500" href="shop-grid.html">Shop</a></li>
              <li><a class="font-xs color-gray-500" href="shop-cart.html">Checkout</a></li>
            </ul>
          </div>
        </div>
      </div>
      <section class="section-box shop-template">
        <div class="container">
        <div class="col-lg-6 col-5 mb-20"><a class="btn font-sm-bold color-brand-1 arrow-back-1" th:href="@{/customer/cart/cartitems}">Return to Cart</a></div>
          <div class="row">
            <div class="col-lg-6">
              <div class="box-border">
                <div class="box-payment">
               		 <a class="btn btn-gpay  justify-content-center payment-clickable">
	                	<img th:src="@{/assets/imgs/page/checkout/cod2.png}"></a>
	                <a class="btn btn-amazon  justify-content-center payment-clickable">
	                	<img th:src="@{/assets/imgs/page/checkout/paypal.svg}" alt="Ecom"></a>
	                <a class="btn btn-amazon  justify-content-center payment-clickable">
	                	<img th:src="@{/assets/imgs/page/checkout/vnpay.png}"></a>
                </div>
                <div class="border-bottom-4 text-center mb-20">
                  <div class="text-or font-md color-gray-500">Or</div>
                </div>
                <div class="row">                 
                  <div class="col-lg-12">
                    <h5 class="font-md-bold color-brand-3 mt-15 mb-20">Shipping address</h5>
                  </div>
                  <!-- Add address -->
                  <button class="btn btn-buy w-auto h5 font-md-bold"
						type="button" id="addAddressButton"
						data-bs-toggle="modal" data-bs-target="#addAddressModal">+
						Add address</button>
					<!-- Add address Modal -->
					<div class="modal fade" id="addAddressModal" tabindex="-1"
						aria-labelledby="addAddressModal" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h1 class="modal-title fs-5" id="exampleModalLabel">Add
										address</h1>
									<button type="button" class="btn-close"
										data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body">
									<form method="post"
										th:action="@{/customer/addaddressincheckout}"
										id="addAddressForm">
										<div class="row">
											<div class="col-lg-12">
												<div class="row gx-3">
													<div class="col-lg-12 mb-3">
														<input type="text" hidden="hidden" name="checkoutItems" th:value=${checkoutItems}>
														<input class="form-control mb-2" type="text"
															name="userId" th:value="${user.id}"
															required="required" hidden> <label
															class="form-label">Location name</label> 
														<input
															class="form-control mb-2" type="text"
															id="addAddressName"
															th:field="${addAddressVariable.name}"
															required="required"
															placeholder="Your address name to easy remember">
														<label class="form-label">Address</label> <input
															class="form-control mb-2" type="text"
															id="addressInput"
															th:field="${addAddressVariable.address}"
															required="required" placeholder="123 street 123">
														<div id="addressError" class="text-danger mb-2"
															style="display: none;"></div>
														<div class="row">
															<div class="col-md-12 mb-2">
																<!-- Province -->
																<select class="form-select" id="provinceSelect"
																	th:field="${addAddressVariable.provinces.code}">
																	<option value="" selected>Select
																		province/city</option>
																	<option th:each="province : ${provinces}"
																		th:value="${province.code}"
																		th:text="${province.administrativeUnits.shortName}+' '+${province.name}">
																	</option>
																</select>
	
															</div>
	
															<div class="col-md-6 mb-2">
																<!-- District -->
																<select class="form-select" id="districtSelect"
																	th:field="${addAddressVariable.districts.code}">
																	<option value="" disabled selected>Select
																		district</option>
																	<option th:each="district : ${districts}"
																		th:value="${district.code}"
																		th:text="${district.shortName}+' '+${district.name}">
																	</option>
																</select>
															</div>
															<div class="col-md-6 mb-2">
																<!-- Ward -->
																<select class="form-select" id="wardSelect"
																	th:field="${addAddressVariable.wards.code}">
																	<option value="" disabled selected>Select
																		ward</option>
																	<option th:each="ward : ${wards}"
																		th:value="${ward.code}"
																		th:text="${ward.shortName}+' '+${ward.name}">
																	</option>
																</select>
															</div>
															<div id="provinceError" class="text-danger mb-2"
																style="display: none;"></div>
															<div id="districtError" class="text-danger mb-2"
																style="display: none;"></div>
															<div id="wardError" class="text-danger mb-2"
																style="display: none;"></div>
														</div>
													</div>
	
	
												</div>
											</div>
										</div>
	
									</form>
								</div>
								<div class="modal-footer">
									<button type="button"
										class="btn btn-cart-delete w-auto"
										data-bs-dismiss="modal">Close</button>
									<button type="button" class="btn btn-cart w-auto"
										id="addAddressSubmitButton">Save changes</button>
								</div>
							</div>
						</div>
					</div>
				<!-- script for add address -->
				<script>
					document.addEventListener("DOMContentLoaded", function () {
						const provinceSelect = document.getElementById("provinceSelect");
						const districtSelect = document.getElementById("districtSelect");
						const wardSelect = document.getElementById("wardSelect");
						
						const addressInput = document.getElementById("addressInput");
						const addAddressModal = document.getElementById('addAddressModal');
						const addressError = document.getElementById("addressError");
						const provinceError = document.getElementById("provinceError");
						const districtError = document.getElementById("districtError");
						const wardError = document.getElementById("wardError");
						
						function isBlank(str) {
				            return str === null || str.trim() === '';
				        }
						
						provinceSelect.addEventListener("change", function () {
							const provinceCode = this.value;
							districtSelect.innerHTML = '<option selected disabled>Loading...</option>';
							wardSelect.innerHTML = '<option selected disabled>Ward</option>';
							wardSelect.disabled = true;
			
							fetch(`/api/address/districts?provinceCode=${provinceCode}`)
							    .then(response => response.json())
							    .then(data => {
							        console.log(data);
							        // Clear existing options BEFORE adding new ones
							        districtSelect.innerHTML = '<option selected disabled>District</option>'; // Keep the default "District" option
							        data.forEach(district => {
							            const option = document.createElement("option");
							            option.value = district.code;
							            option.text = district.shortName+ ' ' + district.name;
							            districtSelect.appendChild(option);
							        });
							        districtSelect.disabled = false;
							    })
							    .catch(error => console.error('Error fetching districts:', error)); // Always good to handle errors
						});
			
						districtSelect.addEventListener("change", function () {
							const districtCode = this.value;
							wardSelect.innerHTML = '<option selected disabled>Loading...</option>';
			
							fetch(`/api/address/wards?districtCode=${districtCode}`)
								.then(response => response.json())
								.then(data => {
									wardSelect.innerHTML = '<option selected disabled>Ward</option>';
									data.forEach(ward => {
										const option = document.createElement("option");
										option.value = ward.code;
										option.text = ward.shortName+ ' ' + ward.name;
										wardSelect.appendChild(option);
									});
									wardSelect.disabled = false;
								});
						});
						addAddressModal.addEventListener('hidden.bs.modal',function(){
							if(addressInput.value != null){
								addressInput.value = '';
							}
							provinceSelect.value = '';
							// Reset district select
				            districtSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
				           districtSelect.disabled = false; // Enable it so it's not stuck disabled
			
				           // Reset ward select
				           wardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
				            wardSelect.disabled = true;
						});
						addAddressSubmitButton.addEventListener('click', function (event) {
				            // Prevent the default form submission for now
				            event.preventDefault();
			
				            let isValid = true;
			
				            // Validate Address Input
				            if (isBlank(addressInput.value)) {
				                addressInput.classList.add('is-invalid'); // Add Bootstrap validation error style
				                addressError.textContent = 'Address cannot be empty or just spaces.';
				                addressError.style.display = 'block';
				                isValid = false;
				            } else {
				                addressInput.classList.remove('is-invalid');
				                addressError.style.display = 'none';
				                addressError.textContent = '';
				            }
				            //province error
				            if (provinceSelect.value === '') {
					            provinceSelect.classList.add('is-invalid');
					            provinceError.textContent = 'Province and city cannot be empty.';
				                provinceError.style.display = 'block';
					            isValid = false;
					        } else {
					            provinceSelect.classList.remove('is-invalid');
					            provinceError.style.display = 'none';
				                provinceError.textContent = '';
					        }
				            //district error
				            if (districtSelect.value === '') {
				            	districtSelect.classList.add('is-invalid');
				            	districtError.textContent = 'District cannot be empty.';
				                districtError.style.display = 'block';
					            isValid = false;
					        } else {
					        	districtSelect.classList.remove('is-invalid');
					        	districtError.style.display = 'none';
				                districtError.textContent = '';
					        }
				            //ward error
				            if (wardSelect.value === '') {
					            wardSelect.classList.add('is-invalid');
					            wardError.textContent = 'Ward cannot be empty.';
				                wardError.style.display = 'block';
					            isValid = false;
					        } else {
					            wardSelect.classList.remove('is-invalid');
					            wardError.style.display = 'none';
				                wardError.textContent = '';
					        }
			
			
				            if (isValid) {
				                document.getElementById('addAddressForm').submit();
				            }
				        });
			
				        // --- Clear data when modal closes ---
				        addAddressModal.addEventListener('hidden.bs.modal', function () {
				            // Clear the address input
				            addressInput.value = '';
				            addressInput.classList.remove('is-invalid'); // Remove error styles
				            addressError.style.display = 'none';
				            addressError.textContent = '';
			
				            // Reset province select
				            provinceSelect.value = ''; // Or set to the value of your default "Select province/city" option
				            districtSelect.innerHTML = '<option value="" disabled selected>Select province/city</option>';
				            provinceSelect.classList.remove('is-invalid'); // Remove error styles
			
				            // Reset district select
				            districtSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
				            districtSelect.disabled = false;
				            districtSelect.classList.remove('is-invalid'); // Remove error styles
			
				            // Reset ward select
				            wardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
				            wardSelect.disabled = true;
				            wardSelect.classList.remove('is-invalid'); // Remove error styles
				        });
			
				        // Optional: Remove validation errors as user types/changes
				        addressInput.addEventListener('input', function() {
				            if (!isBlank(this.value)) {
				                this.classList.remove('is-invalid');
				                addressError.style.display = 'none';
				                addressError.textContent = '';
				            }
				        });
				        provinceSelect.addEventListener('change', function() {
				            this.classList.remove('is-invalid');
				        });
				        districtSelect.addEventListener('change', function() {
				            this.classList.remove('is-invalid');
				        });
				        wardSelect.addEventListener('change', function() {
				            this.classList.remove('is-invalid');
				        });
					});
					</script>
                  <!-- delete Address -->
                  <div class="modal fade" id="deleteAddressModal" tabindex="-1"
						aria-labelledby="editAddressModal" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h1 class="modal-title fs-5" id="exampleModalLabel">Delete
										address</h1>
									<button type="button" class="btn-close"
										data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body">
									<form method="post" th:action="@{/customer/deleteaddressincheckout}"
										id="deleteAddressForm">
											<input type="text" hidden="hidden" name="checkoutItems" th:value=${checkoutItems}>
											<input type="number" id="deleteAddressInput" name="addressId" hidden>
									</form>
									<p>Are you sure you want to delete this address?</p>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-cart-delete w-auto"
										data-bs-dismiss="modal">Cancel</button>
									<button type="button" class="btn btn-cart w-auto"
										id="deleteAddressSubmitButton">Yes</button>
								</div>
							</div>
						</div>
					</div>
					<!-- Edit address modal -->
					<div class="modal fade" id="editAddressModal" tabindex="-1"
						aria-labelledby="editAddressModal" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h1 class="modal-title fs-5" id="exampleModalLabel">Edit
										address</h1>
									<button type="button" class="btn-close"
										data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body">
									<form method="post" th:action="@{/customer/editaddressincheckout}"
										id="editAddressForm">
										<input type="text" hidden="hidden" name="checkoutItems" th:value=${checkoutItems}>
										<div class="row">
											<div class="col-lg-12">
												<div class="row gx-3">
													<div class="col-lg-12 mb-3">
														<input class="form-control mb-2" type="text"
															id="addAddressVariable"
															th:field="${addAddressVariable.id}"
															required="required" hidden> <input
															class="form-control mb-2" type="text"
															name="userId" th:value="${user.id}"
															required="required" hidden> <label
															class="form-label">Location name</label> <input
															class="form-control mb-2" type="text"
															id="editAddressName"
															th:field="${addAddressVariable.name}"
															required="required"
															placeholder="your address name to easy to remember edit">
														<label class="form-label">Address</label> <input
															class="form-control mb-2" type="text"
															id="editaddressInput"
															th:field="${addAddressVariable.address}"
															required="required" placeholder="123 street 123">
														<div id="editaddressError" class="text-danger mb-2"
															style="display: none;"></div>
														<div class="row">
															<div class="col-md-12 mb-2">
																<!-- Province -->
																<select class="form-select"
																	id="editprovinceSelect" name="editProvince">
																	<option id="editprovinceOption" value=""
																		selected>Select province/city</option>
																	<option th:each="province : ${provinces}"
																		th:value="${province.code}"
																		th:text="${province.administrativeUnits.shortName}+' '+${province.name}">
																	</option>
																</select>
	
															</div>
	
															<div class="col-md-6 mb-2">
																<!-- District -->
																<select class="form-select"
																	id="editdistrictSelect" name="editDistrict">
																	<option id="editdistrictOption" value=""
																		selected>Select district</option>
																	<option th:each="district : ${districts}"
																		th:value="${district.code}"
																		th:text="${district.shortName}+' '+${district.name}">
																	</option>
																</select>
															</div>
															<div class="col-md-6 mb-2">
																<!-- Ward -->
																<select class="form-select" id="editwardSelect"
																	name="editWard">
																	<option id="editwardOption" value="" selected>Select
																		ward</option>
																	<option th:each="ward : ${wards}"
																		th:value="${ward.code}"
																		th:text="${ward.shortName}+' '+${ward.name}">
																	</option>
																</select>
															</div>
															<div id="editprovinceError"
																class="text-danger mb-2" style="display: none;"></div>
															<div id="editdistrictError"
																class="text-danger mb-2" style="display: none;"></div>
															<div id="editwardError" class="text-danger mb-2"
																style="display: none;"></div>
														</div>
													</div>
	
	
												</div>
											</div>
										</div>	
									</form>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-cart-delete w-auto"
										data-bs-dismiss="modal">Close</button>
									<button type="button" class="btn btn-cart w-auto"
										id="editAddressSubmitButton">Save changes</button>
								</div>
							</div>
						</div>
					</div>
	
					<!-- begin edit address handler -->
					<script>
						document.addEventListener("DOMContentLoaded", function () {
							const editprovinceSelect = document.getElementById("editprovinceSelect");
							const editdistrictSelect = document.getElementById("editdistrictSelect");
							const editwardSelect = document.getElementById("editwardSelect");
							
							const editaddressInput = document.getElementById("editaddressInput");
							const editAddressModal = document.getElementById('editAddressModal');
							const editaddressError = document.getElementById("editaddressError");
							const editprovinceError = document.getElementById("editprovinceError");
							const editdistrictError = document.getElementById("editdistrictError");
							const editwardError = document.getElementById("editwardError");
							
							function isBlank(str) {
					            return str === null || str.trim() === '';
					        }
							
							editprovinceSelect.addEventListener("change", function () {
								const provinceCode = this.value;
								editdistrictSelect.innerHTML = '<option selected disabled>Loading...</option>';
								editwardSelect.innerHTML = '<option selected disabled>Ward</option>';
								editwardSelect.disabled = true;
				
								fetch(`/api/address/districts?provinceCode=${provinceCode}`)
								    .then(response => response.json())
								    .then(data => {
								        console.log(data);
								        // Clear existing options BEFORE adding new ones
								        editdistrictSelect.innerHTML = '<option selected disabled>District</option>'; // Keep the default "District" option
								        data.forEach(district => {
								            const option = document.createElement("option");
								            option.value = district.code;
								            option.text = district.shortName+ ' ' + district.name;
								            editdistrictSelect.appendChild(option);
								        });
								        editdistrictSelect.disabled = false;
								    })
								    .catch(error => console.error('Error fetching districts:', error)); // Always good to handle errors
							});
				
							editdistrictSelect.addEventListener("change", function () {
								const districtCode = this.value;
								editwardSelect.innerHTML = '<option selected disabled>Loading...</option>';
				
								fetch(`/api/address/wards?districtCode=${districtCode}`)
									.then(response => response.json())
									.then(data => {
										editwardSelect.innerHTML = '<option selected disabled>Ward</option>';
										data.forEach(ward => {
											const option = document.createElement("option");
											option.value = ward.code;
											option.text = ward.shortName+ ' ' + ward.name;
											editwardSelect.appendChild(option);
										});
										editwardSelect.disabled = false;
									});
							});
							editAddressModal.addEventListener('hidden.bs.modal',function(){
								if(editaddressInput.value != null){
									editaddressInput.value = '';
								}
								editprovinceSelect.value = '';
								// Reset district select
					            editdistrictSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
					           editdistrictSelect.disabled = false; // Enable it so it's not stuck disabled
				
					           // Reset ward select
					           editwardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
					            editwardSelect.disabled = true;
							});
							editAddressSubmitButton.addEventListener('click', function (event) {
					            // Prevent the default form submission for now
					            event.preventDefault();
				
					            let isValid = true;
				
					            // Validate Address Input
					            if (isBlank(editaddressInput.value)) {
					            	editaddressInput.classList.add('is-invalid'); // Add Bootstrap validation error style
					            	editaddressError.textContent = 'Address cannot be empty or just spaces.';
					            	editaddressError.style.display = 'block';
					                isValid = false;
					            } else {
					            	editaddressInput.classList.remove('is-invalid');
					            	editaddressError.style.display = 'none';
					            	editaddressError.textContent = '';
					            }
					            //province error
					            if (editprovinceSelect.value === '') {
					            	editprovinceSelect.classList.add('is-invalid');
					            	editprovinceError.textContent = 'Province and city cannot be empty.';
					            	editprovinceError.style.display = 'block';
						            isValid = false;
						        } else {
						        	editprovinceSelect.classList.remove('is-invalid');
						        	editprovinceError.style.display = 'none';
						        	editprovinceError.textContent = '';
						        }
					            //district error
					            if (editdistrictSelect.value === '') {
					            	editdistrictSelect.classList.add('is-invalid');
					            	editdistrictError.textContent = 'District cannot be empty.';
					            	editdistrictError.style.display = 'block';
						            isValid = false;
						        } else {
						        	editdistrictSelect.classList.remove('is-invalid');
						        	editdistrictError.style.display = 'none';
						        	editdistrictError.textContent = '';
						        }
					            //ward error
					            if (editwardSelect.value === '') {
					            	editwardSelect.classList.add('is-invalid');
					            	editwardError.textContent = 'Ward cannot be empty.';
					            	editwardError.style.display = 'block';
						            isValid = false;
						        } else {
						        	editwardSelect.classList.remove('is-invalid');
						        	editwardError.style.display = 'none';
						        	editwardError.textContent = '';
						        }
				
				
					            if (isValid) {
					                document.getElementById('editAddressForm').submit();
					            }
					        });
				
					        // --- Clear data when modal closes ---
					        editAddressModal.addEventListener('hidden.bs.modal', function () {
					            // Clear the address input
					            editaddressInput.value = '';
					            editaddressInput.classList.remove('is-invalid'); // Remove error styles
					            editaddressError.style.display = 'none';
					            editaddressError.textContent = '';
				
					            // Reset province select
					            editprovinceSelect.value = ''; // Or set to the value of your default "Select province/city" option
					            editdistrictSelect.innerHTML = '<option value="" disabled selected>Select province/city</option>';
					            editprovinceSelect.classList.remove('is-invalid'); // Remove error styles
				
					            // Reset district select
					            editdistrictSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
					            editdistrictSelect.disabled = false;
					            editdistrictSelect.classList.remove('is-invalid'); // Remove error styles
				
					            // Reset ward select
					            editwardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
					            editwardSelect.disabled = true;
					            editwardSelect.classList.remove('is-invalid'); // Remove error styles
					        });
				
					        // Optional: Remove validation errors as user types/changes
					        editaddressInput.addEventListener('input', function() {
					            if (!isBlank(this.value)) {
					                this.classList.remove('is-invalid');
					                editaddressError.style.display = 'none';
					                editaddressError.textContent = '';
					            }
					        });
					        editprovinceSelect.addEventListener('change', function() {
					            this.classList.remove('is-invalid');
					        });
					        editdistrictSelect.addEventListener('change', function() {
					            this.classList.remove('is-invalid');
					        });
					        editwardSelect.addEventListener('change', function() {
					            this.classList.remove('is-invalid');
					        });
						});
						</script>
					
					<script th:src="@{/client/assets/js/vendors/jquery-3.6.0.min.js}"></script>
					<script>
						$(document).ready(function(){
							$('.deleteAddress').on('click',function(event){
								event.preventDefault();
								var deleteAddressId = $(this).data('address-id');
								$('#deleteAddressInput').val(deleteAddressId);
								if(deleteAddressId){
									$('#deleteAddressSubmitButton').on('click',function(){
										$('#deleteAddressForm').submit();
									});
								}
								$('#deleteAddressModal').modal('show');
							});
						});
					</script>
					
					<script>                                                
													$(document).ready(function() {
													    $('.changeAddress').on('click', function(event) {
													        event.preventDefault(); // Prevent default button behavior if it's a link
													
													        // Get the address ID from a data attribute
													        var editAddressId = $(this).data('address-id');
													        // Set the address ID to a hidden input field
													        document.getElementById('addAddressVariable').value = editAddressId;
													
													        if (editAddressId) {
													            $.ajax({
													                url: '/customer/api/address/geteditaddress', // Your Spring Boot endpoint URL
													                type: 'GET',
													                data: { editAddressId: editAddressId },
													                success: async function(userAddress) { // Made the success function asynchronous
													                    // Check if data is received and is not null
													                    if (userAddress) {
													                        // Populate simple input fields
													                        $('#editAddressForm input[name="name"]').val(userAddress.name);
													                        $('#editAddressForm input[name="address"]').val(userAddress.address);
																			
													                        // --- Step 1: Populate Provinces ---
													                        if (userAddress.provinces) {
													                            $('#editprovinceSelect').val(userAddress.provincesCode);
													                            $('#editprovinceSelect').trigger('change');                          
													                            console.log($('#editprovinceSelect'));
													                            // No need to trigger change here if we are programmatically fetching districts/wards
													                            // unless there's another independent listener for real-time user selection updates.
													                        }
													                        // --- Step 2: Populate Districts (after provinces are set) ---
													                        if (userAddress.districts && userAddress.provincesCode) {
													                            try {
													                                const response = await fetch(`/api/address/districts?provinceCode=${userAddress.provincesCode}`);
													                                const data = await response.json();
																					
													                              
													                                
													                                data.forEach(district => {
													                                    const option = document.createElement("option");
													                                    option.value = district.code;
													                                    option.text = district.shortName + ' ' + district.name;
													                                    editdistrictSelect.appendChild(option);
													                                });
													                                editdistrictSelect.disabled = false; // Enable the district dropdown
													                                
													                                // Set the current district value AFTER all options are loaded
													                                $('#editdistrictSelect').val(userAddress.districtsCode);                              
													                                $('#editdistrictSelect').trigger('change');
													                               // Ensure value is also set for option
													                            } catch (error) {
													                                console.error('Error fetching districts:', error);
													                            }
													                        }
													
													                        // --- Step 3: Populate Wards (after districts are set) ---
													                        // Ensure userAddress.districtsCode is used for the API call
													                        if (userAddress.wards && userAddress.districtsCode) { 
													                            try {
													                                const response = await fetch(`/api/address/wards?districtCode=${userAddress.districtsCode}`);
													                                const data = await response.json();
													
													                                const editwardSelect = document.getElementById('editwardSelect'); // Ensure this ID matches your HTML
													                                editwardSelect.innerHTML = '<option selected disabled>Ward</option>'; // Keep the default option
													                                
													                                data.forEach(ward => {
													                                    const option = document.createElement("option");
													                                    option.value = ward.code;
													                                    option.text = ward.shortName + ' ' + ward.name;
													                                    editwardSelect.appendChild(option);
													                                });
													                                editwardSelect.disabled = false; // Enable the ward dropdown
													                                
													                                // Set the current ward value AFTER all options are loaded
													                                $('#editwardSelect').val(userAddress.wardsCode);
													                                $('#editwardSelect').trigger('change');
													                                // Set the text for a display element, if it exists
													                                // Ensure value is also set for option
													                            } catch (error) {
													                                console.error('Error fetching wards:', error);
													                            }
													                        }
													
													                        // Show the modal after all dropdowns are potentially populated
													                        $('#editAddressModal').modal('show');
													                         
													                        // Handle hidden ID input for form submission
													                        if ($('#addAddressForm input[name="id"]').length === 0) { // Check if an ID input already exists
													                            $('#addAddressForm').prepend('<input type="hidden" name="id" value="' + userAddress.id + '">');
													                        } else {
													                            $('#addAddressForm input[name="id"]').val(userAddress.id);
													                        }
													
													                    } else {
													                        console.error('No address data received.');
													                        // Use a custom message box instead of alert()
													                        // You would need to implement a custom modal or div for this.
													                        // For demonstration, a console log is used.
													                        console.log('Error: Could not retrieve address data.'); 
													                    }
													                },
													                error: function(xhr, status, error) {
													                    console.error("AJAX Error:", status, error);
													                    // Use a custom message box instead of alert()
													                    console.log('Error loading address for editing. Please try again.');
													                }
													            });
													        } else {
													            console.error("No address ID found for editing.");
													            // Use a custom message box instead of alert()
													            console.log('Cannot edit address: No ID provided.');
													        }
													    });
													});
													</script>
                  
                  <th:block th:each="userAdress, i : ${userAdresses}">
						<div th:if="${userAdress.deletedAt == null}" class="card mb-2 card-clickable" style="padding: 0;">
							<div class="card-body bg-light">
								<article class="box mb-3 bg-light">
									<a class="btn btn-cart w-auto float-end changeAddress"
										th:data-address-id="${userAdress.id}">Change</a>
										<a
										class="float-end" href="#">&nbsp;&nbsp;&nbsp;</a> 
										<a
										class="btn btn-cart-delete w-auto float-end deleteAddress" th:data-address-id="${userAdress.id}">Delete</a>
									<h6 th:text="${userAdress.name}"></h6>
									<small class="text-muted d-block" style="width: 70%">
										<th:block
											th:text="${userAdress.address}+' '+${userAdress.wards.administrativeUnits.shortName}+' '+${userAdress.wards.name}+' '+${userAdress.districts.administrativeUnits.shortName}+' '+${userAdress.districts.name}+' '+${userAdress.provinces.administrativeUnits.shortName}+' '+${userAdress.provinces.name}"></th:block>
									</small>
								</article>
							</div>
						</div>
					</th:block>              
                </div>
              </div>

            </div>
            <div class="col-lg-6">
              <div class="box-border">
                <h5 class="font-md-bold mb-20">Your Order</h5>
                <div class="listCheckout">
                  	<div class="box-orders" th:each="vendorItems : ${groupedCheckoutList}">
                  		<div class="head-orders">
							<div class="head-left" style="width: 10%">
								<h5 style="margin-left: 4%">
									<a th:text="${vendorItems.key.name}"></a>
								</h5>
							</div>
						</div>
						<div class="body-orders">
							<div class="list-orders">
							
	                  <div class="item-wishlist" th:each="item : ${vendorItems.value}">
	                    <div class="wishlist-product">
	                      <div class="product-wishlist">
	                        <div class="product-image">
		                        <a href="shop-single-product.html">
		                        <th:block th:if="${item.cartItem.products.mediases[0].name.contains('https:')}">
									<img
										th:src="${item.cartItem.products.mediases[0].name}"
										alt="Ecom">
								</th:block> <th:block
									th:if="${!item.cartItem.products.mediases[0].name.contains('https:')}">
									<img
										th:src="@{'/assets/imgs/items/' + ${item.cartItem.products.mediases[0].name}}"
										alt="Ecom">
								</th:block>
		                        	
		                        </a>
	                        </div>
	                        <div class="product-info"><a href="shop-single-product.html">
	                            <h6 class="color-brand-3" th:text="${item.cartItem.products.name}"></h6></a>
	                          <div class="rating">
	                          	
	                          </div>
	                        </div>
	                      </div>
	                    </div>
	                    <div class="wishlist-status">
	                      <h5 class="color-gray-500">x<th:block th:text="${item.cartItem.quantity}"></th:block></h5>
	                    </div>
	                    <div class="wishlist-price">
	                      	<th:block th:if="${item.hasDiscount}">								
								<h5 class="color-brand-3">
									$
									<th:block th:text="${item.afterDiscountPrice * item.cartItem.quantity}"></th:block>
								</h5>
							</th:block>
							<th:block th:if="${!item.hasDiscount}">
								<h5 class="color-brand-3">
									$
									<th:block th:text="${item.originalPrice * item.cartItem.quantity}"></th:block>
								</h5>
							</th:block>
	                    </div>
	                  </div>
	              
							</div>
						</div>
						<!-- choose voucher -->
							<div class="form-group d-flex mx-4">
							  <div class="input-group">
							    <input type="text" class="form-control" placeholder="Choose Your Voucher" readonly="readonly">
							    <div class="input-group-append">
							      <button class="btn btn-buy" type="button">Apply</button>
							    </div>
							  </div>
							</div>
							
							<div class="modal fade" id="editAddressModal" tabindex="-1"
								aria-labelledby="chooseVoucherModal" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<h1 class="modal-title fs-5" id="exampleModalLabel">Your voucher</h1>
											<button type="button" class="btn-close"
												data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
										
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-cart-delete w-auto"
												data-bs-dismiss="modal">Close</button>
											<button type="button" class="btn btn-cart w-auto"
												id="editAddressSubmitButton">Save changes</button>
										</div>
									</div>
								</div>
							</div>
												
												
                  	</div>
                  
                </div>

                <div class="form-group mb-0">
                  <div class="row mb-10">
                    <div class="col-lg-6 col-6"><span class="font-md-bold color-brand-3">Subtotal</span></div>
                    <div class="col-lg-6 col-6 text-end d-flex justify-content-end"><span class="font-lg-bold color-brand-3">$</span><div class="font-lg-bold color-brand-3" th:text=${subTotal}></div></div>
                  </div>
                  <div class="border-bottom mb-10 pb-5">
                    <div class="row">
                      <div class="col-lg-6 col-6"><span class="font-md-bold color-brand-3">Shipping</span></div>
                      <div class="col-lg-6 col-6 text-end"><span class="font-lg-bold color-brand-3">-</span></div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-lg-6 col-6"><span class="font-md-bold color-brand-3">Total</span></div>
                    <div class="col-lg-6 col-6 text-end"><span class="font-lg-bold color-brand-3">$6.51</span></div>
                  </div>
                </div>
              </div>
              <div class="row mt-20">
                <div class="col-lg-6 col-7 mb-20 text-end">&nbsp;</div>
                <div class="col-lg-6 col-7 mb-20 text-end"><a class="btn btn-buy w-auto arrow-next" href="shop-checkout.html">Place an Order</a></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="section-box mt-90 mb-50">
        <div class="container">
          <ul class="list-col-5">
            <li>
              <div class="item-list">
                <div class="icon-left"><img th:src="@{/assets/imgs/template/delivery.svg}" alt="Ecom"></div>
                <div class="info-right">
                  <h5 class="font-lg-bold color-gray-100">Free Delivery</h5>
                  <p class="font-sm color-gray-500">From all orders over $10</p>
                </div>
              </div>
            </li>
            <li>
              <div class="item-list">
                <div class="icon-left"><img th:src="@{/assets/imgs/template/support.svg}" alt="Ecom"></div>
                <div class="info-right">
                  <h5 class="font-lg-bold color-gray-100">Support 24/7</h5>
                  <p class="font-sm color-gray-500">Shop with an expert</p>
                </div>
              </div>
            </li>
            <li>
              <div class="item-list">
                <div class="icon-left"><img th:src="@{/assets/imgs/template/voucher.svg}" alt="Ecom"></div>
                <div class="info-right">
                  <h5 class="font-lg-bold color-gray-100">Gift voucher</h5>
                  <p class="font-sm color-gray-500">Refer a friend</p>
                </div>
              </div>
            </li>
            <li>
              <div class="item-list">
                <div class="icon-left"><img th:src="@{/assets/imgs/template/return.svg}" alt="Ecom"></div>
                <div class="info-right">
                  <h5 class="font-lg-bold color-gray-100">Return &amp; Refund</h5>
                  <p class="font-sm color-gray-500">Free return over $200</p>
                </div>
              </div>
            </li>
            <li>
              <div class="item-list">
                <div class="icon-left"><img th:src="@{/assets/imgs/template/secure.svg}" alt="Ecom"></div>
                <div class="info-right">
                  <h5 class="font-lg-bold color-gray-100">Secure payment</h5>
                  <p class="font-sm color-gray-500">100% Protected</p>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </section>
      </main>

</body>