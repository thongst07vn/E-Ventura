<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{customer/layouts/layout :: layout('Product details', ~{this :: .content-main})}">

<head>
<title>DashBoard</title>
</head>

<body>
	<main class="main content-main">
		<div class="section-box">
			<div class="breadcrumbs-div">
				<div class="container">
					<ul class="breadcrumb">
						<li><a class="font-xs color-gray-1000" href="index.html">Home</a></li>
						<li><a class="font-xs color-gray-500" href="shop-grid.html">Shop</a></li>
						<li><a class="font-xs color-gray-500" href="shop-cart.html">Checkout</a></li>
					</ul>
				</div>
			</div>
		</div>
		<section class="section-box shop-template">
			<div class="container">
				<div class="col-lg-6 col-5 mb-20">
					<a class="btn font-sm-bold color-brand-1 arrow-back-1"
						th:href="@{/customer/cart/cartitems}">Return to Cart</a>
				</div>

				<div class="row">
					<div class="col-lg-6">

						<div class="box-border">
							<div class="border-bottom-4 text-center mb-35">
								<div class="text-or font-md color-gray-500">
									<h5 class="font-md-bold color-brand-3">Payment method</h5>
								</div>
							</div>
							<div class="box-payment">
								<a id="payment-cod"
									class="btn btn-gpay justify-content-center payment-clickable onselected-checkout">
									<img th:src="@{/assets/imgs/page/checkout/cod2.png}">
								</a> <a id="payment-paypal"
									class="btn btn-amazon justify-content-center payment-clickable">
									<img th:src="@{/assets/imgs/page/checkout/paypal.svg}"
									alt="Ecom">
								</a> <a id="payment-vnpay"
									class="btn btn-amazon justify-content-center payment-clickable">
									<img th:src="@{/assets/imgs/page/checkout/vnpay.png}">
								</a>
							</div>
							<div class="border-bottom-4 text-center mb-35">
								<div class="text-or font-md color-gray-500">
									<h5 class="font-md-bold color-brand-3">Shipping address</h5>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-12"></div>
								<!-- Add address -->
								<button class="btn btn-buy w-auto h5 font-md-bold mb-3"
									type="button" id="addAddressButton" data-bs-toggle="modal"
									data-bs-target="#addAddressModal">+ Add address</button>
								<!-- Add address Modal -->
								<div class="modal fade" id="addAddressModal" tabindex="-1"
									aria-labelledby="addAddressModal" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h1 class="modal-title fs-5" id="exampleModalLabel">Add
													address</h1>
												<button type="button" class="btn-close"
													data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<form method="post"
													th:action="@{/customer/addaddressincheckout}"
													id="addAddressForm">
													<div class="row">
														<div class="col-lg-12">
															<div class="row gx-3">
																<div class="col-lg-12 mb-3">
																	<input type="text" hidden="hidden" name="checkoutItems"
																		th:value=${checkoutItems}> <input
																		class="form-control mb-2" type="text" name="userId"
																		th:value="${user.id}" required="required" hidden>
																	<label class="form-label">Location name</label> <input
																		class="form-control mb-2" type="text"
																		id="addAddressName"
																		th:field="${addAddressVariable.name}"
																		required="required"
																		placeholder="Your address name to easy remember">
																	<label class="form-label">Address</label> <input
																		class="form-control mb-2" type="text"
																		id="addressInput"
																		th:field="${addAddressVariable.address}"
																		required="required" placeholder="123 street 123">
																	<div id="addressError" class="text-danger mb-2"
																		style="display: none;"></div>
																	<div class="row">
																		<div class="col-md-12 mb-2">
																			<!-- Province -->
																			<select class="form-select" id="provinceSelect"
																				th:field="${addAddressVariable.provinces.code}">
																				<option value="" selected>Select
																					province/city</option>
																				<option th:each="province : ${provinces}"
																					th:value="${province.code}"
																					th:text="${province.administrativeUnits.shortName}+' '+${province.name}">
																				</option>
																			</select>

																		</div>

																		<div class="col-md-6 mb-2">
																			<!-- District -->
																			<select class="form-select" id="districtSelect"
																				th:field="${addAddressVariable.districts.code}">
																				<option value="" disabled selected>Select
																					district</option>
																				<option th:each="district : ${districts}"
																					th:value="${district.code}"
																					th:text="${district.shortName}+' '+${district.name}">
																				</option>
																			</select>
																		</div>
																		<div class="col-md-6 mb-2">
																			<!-- Ward -->
																			<select class="form-select" id="wardSelect"
																				th:field="${addAddressVariable.wards.code}">
																				<option value="" disabled selected>Select
																					ward</option>
																				<option th:each="ward : ${wards}"
																					th:value="${ward.code}"
																					th:text="${ward.shortName}+' '+${ward.name}">
																				</option>
																			</select>
																		</div>
																		<div id="provinceError" class="text-danger mb-2"
																			style="display: none;"></div>
																		<div id="districtError" class="text-danger mb-2"
																			style="display: none;"></div>
																		<div id="wardError" class="text-danger mb-2"
																			style="display: none;"></div>
																	</div>
																</div>


															</div>
														</div>
													</div>

												</form>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-cart-delete w-auto"
													data-bs-dismiss="modal">Close</button>
												<button type="button" class="btn btn-cart w-auto"
													id="addAddressSubmitButton">Save changes</button>
											</div>
										</div>
									</div>
								</div>
								<!-- script for add address -->
								<script>
					document.addEventListener("DOMContentLoaded", function () {
						const provinceSelect = document.getElementById("provinceSelect");
						const districtSelect = document.getElementById("districtSelect");
						const wardSelect = document.getElementById("wardSelect");
						
						const addressInput = document.getElementById("addressInput");
						const addAddressModal = document.getElementById('addAddressModal');
						const addressError = document.getElementById("addressError");
						const provinceError = document.getElementById("provinceError");
						const districtError = document.getElementById("districtError");
						const wardError = document.getElementById("wardError");
						
						function isBlank(str) {
				            return str === null || str.trim() === '';
				        }
						
						provinceSelect.addEventListener("change", function () {
							const provinceCode = this.value;
							districtSelect.innerHTML = '<option selected disabled>Loading...</option>';
							wardSelect.innerHTML = '<option selected disabled>Ward</option>';
							wardSelect.disabled = true;
			
							fetch(`/api/address/districts?provinceCode=${provinceCode}`)
							    .then(response => response.json())
							    .then(data => {
							        console.log(data);
							        // Clear existing options BEFORE adding new ones
							        districtSelect.innerHTML = '<option selected disabled>District</option>'; // Keep the default "District" option
							        data.forEach(district => {
							            const option = document.createElement("option");
							            option.value = district.code;
							            option.text = district.shortName+ ' ' + district.name;
							            districtSelect.appendChild(option);
							        });
							        districtSelect.disabled = false;
							    })
							    .catch(error => console.error('Error fetching districts:', error)); // Always good to handle errors
						});
			
						districtSelect.addEventListener("change", function () {
							const districtCode = this.value;
							wardSelect.innerHTML = '<option selected disabled>Loading...</option>';
			
							fetch(`/api/address/wards?districtCode=${districtCode}`)
								.then(response => response.json())
								.then(data => {
									wardSelect.innerHTML = '<option selected disabled>Ward</option>';
									data.forEach(ward => {
										const option = document.createElement("option");
										option.value = ward.code;
										option.text = ward.shortName+ ' ' + ward.name;
										wardSelect.appendChild(option);
									});
									wardSelect.disabled = false;
								});
						});
						addAddressModal.addEventListener('hidden.bs.modal',function(){
							if(addressInput.value != null){
								addressInput.value = '';
							}
							provinceSelect.value = '';
							// Reset district select
				            districtSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
				           districtSelect.disabled = false; // Enable it so it's not stuck disabled
			
				           // Reset ward select
				           wardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
				            wardSelect.disabled = true;
						});
						addAddressSubmitButton.addEventListener('click', function (event) {
				            // Prevent the default form submission for now
				            event.preventDefault();
			
				            let isValid = true;
			
				            // Validate Address Input
				            if (isBlank(addressInput.value)) {
				                addressInput.classList.add('is-invalid'); // Add Bootstrap validation error style
				                addressError.textContent = 'Address cannot be empty or just spaces.';
				                addressError.style.display = 'block';
				                isValid = false;
				            } else {
				                addressInput.classList.remove('is-invalid');
				                addressError.style.display = 'none';
				                addressError.textContent = '';
				            }
				            //province error
				            if (provinceSelect.value === '') {
					            provinceSelect.classList.add('is-invalid');
					            provinceError.textContent = 'Province and city cannot be empty.';
				                provinceError.style.display = 'block';
					            isValid = false;
					        } else {
					            provinceSelect.classList.remove('is-invalid');
					            provinceError.style.display = 'none';
				                provinceError.textContent = '';
					        }
				            //district error
				            if (districtSelect.value === '') {
				            	districtSelect.classList.add('is-invalid');
				            	districtError.textContent = 'District cannot be empty.';
				                districtError.style.display = 'block';
					            isValid = false;
					        } else {
					        	districtSelect.classList.remove('is-invalid');
					        	districtError.style.display = 'none';
				                districtError.textContent = '';
					        }
				            //ward error
				            if (wardSelect.value === '') {
					            wardSelect.classList.add('is-invalid');
					            wardError.textContent = 'Ward cannot be empty.';
				                wardError.style.display = 'block';
					            isValid = false;
					        } else {
					            wardSelect.classList.remove('is-invalid');
					            wardError.style.display = 'none';
				                wardError.textContent = '';
					        }
			
			
				            if (isValid) {
				                document.getElementById('addAddressForm').submit();
				            }
				        });
			
				        // --- Clear data when modal closes ---
				        addAddressModal.addEventListener('hidden.bs.modal', function () {
				            // Clear the address input
				            addressInput.value = '';
				            addressInput.classList.remove('is-invalid'); // Remove error styles
				            addressError.style.display = 'none';
				            addressError.textContent = '';
			
				            // Reset province select
				            provinceSelect.value = ''; // Or set to the value of your default "Select province/city" option
				            districtSelect.innerHTML = '<option value="" disabled selected>Select province/city</option>';
				            provinceSelect.classList.remove('is-invalid'); // Remove error styles
			
				            // Reset district select
				            districtSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
				            districtSelect.disabled = false;
				            districtSelect.classList.remove('is-invalid'); // Remove error styles
			
				            // Reset ward select
				            wardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
				            wardSelect.disabled = true;
				            wardSelect.classList.remove('is-invalid'); // Remove error styles
				        });
			
				        // Optional: Remove validation errors as user types/changes
				        addressInput.addEventListener('input', function() {
				            if (!isBlank(this.value)) {
				                this.classList.remove('is-invalid');
				                addressError.style.display = 'none';
				                addressError.textContent = '';
				            }
				        });
				        provinceSelect.addEventListener('change', function() {
				            this.classList.remove('is-invalid');
				        });
				        districtSelect.addEventListener('change', function() {
				            this.classList.remove('is-invalid');
				        });
				        wardSelect.addEventListener('change', function() {
				            this.classList.remove('is-invalid');
				        });
					});
					</script>
								<!-- delete Address -->
								<div class="modal fade" id="deleteAddressModal" tabindex="-1"
									aria-labelledby="editAddressModal" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h1 class="modal-title fs-5" id="exampleModalLabel">Delete
													address</h1>
												<button type="button" class="btn-close"
													data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<form method="post"
													th:action="@{/customer/deleteaddressincheckout}"
													id="deleteAddressForm">
													<input type="text" hidden="hidden" name="checkoutItems"
														th:value=${checkoutItems}> <input type="number"
														id="deleteAddressInput" name="addressId" hidden>
												</form>
												<p>Are you sure you want to delete this address?</p>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-cart-delete w-auto"
													data-bs-dismiss="modal">Cancel</button>
												<button type="button" class="btn btn-cart w-auto"
													id="deleteAddressSubmitButton">Yes</button>
											</div>
										</div>
									</div>
								</div>
								<!-- Edit address modal -->
								<div class="modal fade" id="editAddressModal" tabindex="-1"
									aria-labelledby="editAddressModal" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h1 class="modal-title fs-5" id="exampleModalLabel">Edit
													address</h1>
												<button type="button" class="btn-close"
													data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<form method="post"
													th:action="@{/customer/editaddressincheckout}"
													id="editAddressForm">
													<input type="text" hidden="hidden" name="checkoutItems"
														th:value=${checkoutItems}>
													<div class="row">
														<div class="col-lg-12">
															<div class="row gx-3">
																<div class="col-lg-12 mb-3">
																	<input class="form-control mb-2" type="text"
																		id="addAddressVariable"
																		th:field="${addAddressVariable.id}"
																		required="required" hidden> <input
																		class="form-control mb-2" type="text" name="userId"
																		th:value="${user.id}" required="required" hidden>
																	<label class="form-label">Location name</label> <input
																		class="form-control mb-2" type="text"
																		id="editAddressName"
																		th:field="${addAddressVariable.name}"
																		required="required"
																		placeholder="your address name to easy to remember edit">
																	<label class="form-label">Address</label> <input
																		class="form-control mb-2" type="text"
																		id="editaddressInput"
																		th:field="${addAddressVariable.address}"
																		required="required" placeholder="123 street 123">
																	<div id="editaddressError" class="text-danger mb-2"
																		style="display: none;"></div>
																	<div class="row">
																		<div class="col-md-12 mb-2">
																			<!-- Province -->
																			<select class="form-select" id="editprovinceSelect"
																				name="editProvince">
																				<option id="editprovinceOption" value="" selected>Select
																					province/city</option>
																				<option th:each="province : ${provinces}"
																					th:value="${province.code}"
																					th:text="${province.administrativeUnits.shortName}+' '+${province.name}">
																				</option>
																			</select>

																		</div>

																		<div class="col-md-6 mb-2">
																			<!-- District -->
																			<select class="form-select" id="editdistrictSelect"
																				name="editDistrict">
																				<option id="editdistrictOption" value="" selected>Select
																					district</option>
																				<option th:each="district : ${districts}"
																					th:value="${district.code}"
																					th:text="${district.shortName}+' '+${district.name}">
																				</option>
																			</select>
																		</div>
																		<div class="col-md-6 mb-2">
																			<!-- Ward -->
																			<select class="form-select" id="editwardSelect"
																				name="editWard">
																				<option id="editwardOption" value="" selected>Select
																					ward</option>
																				<option th:each="ward : ${wards}"
																					th:value="${ward.code}"
																					th:text="${ward.shortName}+' '+${ward.name}">
																				</option>
																			</select>
																		</div>
																		<div id="editprovinceError" class="text-danger mb-2"
																			style="display: none;"></div>
																		<div id="editdistrictError" class="text-danger mb-2"
																			style="display: none;"></div>
																		<div id="editwardError" class="text-danger mb-2"
																			style="display: none;"></div>
																	</div>
																</div>


															</div>
														</div>
													</div>
												</form>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-cart-delete w-auto"
													data-bs-dismiss="modal">Close</button>
												<button type="button" class="btn btn-cart w-auto"
													id="editAddressSubmitButton">Save changes</button>
											</div>
										</div>
									</div>
								</div>

								<!-- begin edit address handler -->
								<script>
						document.addEventListener("DOMContentLoaded", function () {
							const editprovinceSelect = document.getElementById("editprovinceSelect");
							const editdistrictSelect = document.getElementById("editdistrictSelect");
							const editwardSelect = document.getElementById("editwardSelect");
							
							const editaddressInput = document.getElementById("editaddressInput");
							const editAddressModal = document.getElementById('editAddressModal');
							const editaddressError = document.getElementById("editaddressError");
							const editprovinceError = document.getElementById("editprovinceError");
							const editdistrictError = document.getElementById("editdistrictError");
							const editwardError = document.getElementById("editwardError");
							
							function isBlank(str) {
					            return str === null || str.trim() === '';
					        }
							
							editprovinceSelect.addEventListener("change", function () {
								const provinceCode = this.value;
								editdistrictSelect.innerHTML = '<option selected disabled>Loading...</option>';
								editwardSelect.innerHTML = '<option selected disabled>Ward</option>';
								editwardSelect.disabled = true;
				
								fetch(`/api/address/districts?provinceCode=${provinceCode}`)
								    .then(response => response.json())
								    .then(data => {
								        console.log(data);
								        // Clear existing options BEFORE adding new ones
								        editdistrictSelect.innerHTML = '<option selected disabled>District</option>'; // Keep the default "District" option
								        data.forEach(district => {
								            const option = document.createElement("option");
								            option.value = district.code;
								            option.text = district.shortName+ ' ' + district.name;
								            editdistrictSelect.appendChild(option);
								        });
								        editdistrictSelect.disabled = false;
								    })
								    .catch(error => console.error('Error fetching districts:', error)); // Always good to handle errors
							});
				
							editdistrictSelect.addEventListener("change", function () {
								const districtCode = this.value;
								editwardSelect.innerHTML = '<option selected disabled>Loading...</option>';
				
								fetch(`/api/address/wards?districtCode=${districtCode}`)
									.then(response => response.json())
									.then(data => {
										editwardSelect.innerHTML = '<option selected disabled>Ward</option>';
										data.forEach(ward => {
											const option = document.createElement("option");
											option.value = ward.code;
											option.text = ward.shortName+ ' ' + ward.name;
											editwardSelect.appendChild(option);
										});
										editwardSelect.disabled = false;
									});
							});
							editAddressModal.addEventListener('hidden.bs.modal',function(){
								if(editaddressInput.value != null){
									editaddressInput.value = '';
								}
								editprovinceSelect.value = '';
								// Reset district select
					            editdistrictSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
					           editdistrictSelect.disabled = false; // Enable it so it's not stuck disabled
				
					           // Reset ward select
					           editwardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
					            editwardSelect.disabled = true;
							});
							$('#editAddressSubmitButton').on('click', function (event) {
					            // Prevent the default form submission for now
					            event.preventDefault();
				
					            let isValid = true;
				
					            // Validate Address Input
					            if (isBlank(editaddressInput.value)) {
					            	editaddressInput.classList.add('is-invalid'); // Add Bootstrap validation error style
					            	editaddressError.textContent = 'Address cannot be empty or just spaces.';
					            	editaddressError.style.display = 'block';
					                isValid = false;
					            } else {
					            	editaddressInput.classList.remove('is-invalid');
					            	editaddressError.style.display = 'none';
					            	editaddressError.textContent = '';
					            }
					            //province error
					            if (editprovinceSelect.value === '') {
					            	editprovinceSelect.classList.add('is-invalid');
					            	editprovinceError.textContent = 'Province and city cannot be empty.';
					            	editprovinceError.style.display = 'block';
						            isValid = false;
						        } else {
						        	editprovinceSelect.classList.remove('is-invalid');
						        	editprovinceError.style.display = 'none';
						        	editprovinceError.textContent = '';
						        }
					            //district error
					            if (editdistrictSelect.value === '') {
					            	editdistrictSelect.classList.add('is-invalid');
					            	editdistrictError.textContent = 'District cannot be empty.';
					            	editdistrictError.style.display = 'block';
						            isValid = false;
						        } else {
						        	editdistrictSelect.classList.remove('is-invalid');
						        	editdistrictError.style.display = 'none';
						        	editdistrictError.textContent = '';
						        }
					            //ward error
					            if (editwardSelect.value === '') {
					            	editwardSelect.classList.add('is-invalid');
					            	editwardError.textContent = 'Ward cannot be empty.';
					            	editwardError.style.display = 'block';
						            isValid = false;
						        } else {
						        	editwardSelect.classList.remove('is-invalid');
						        	editwardError.style.display = 'none';
						        	editwardError.textContent = '';
						        }
				
				
					            if (isValid) {
					                document.getElementById('editAddressForm').submit();
					            }
					        });
				
					        // --- Clear data when modal closes ---
					        editAddressModal.addEventListener('hidden.bs.modal', function () {
					            // Clear the address input
					            editaddressInput.value = '';
					            editaddressInput.classList.remove('is-invalid'); // Remove error styles
					            editaddressError.style.display = 'none';
					            editaddressError.textContent = '';
				
					            // Reset province select
					            editprovinceSelect.value = ''; // Or set to the value of your default "Select province/city" option
					            editdistrictSelect.innerHTML = '<option value="" disabled selected>Select province/city</option>';
					            editprovinceSelect.classList.remove('is-invalid'); // Remove error styles
				
					            // Reset district select
					            editdistrictSelect.innerHTML = '<option value="" disabled selected>Select district</option>';
					            editdistrictSelect.disabled = false;
					            editdistrictSelect.classList.remove('is-invalid'); // Remove error styles
				
					            // Reset ward select
					            editwardSelect.innerHTML = '<option value="" disabled selected>Select ward</option>';
					            editwardSelect.disabled = true;
					            editwardSelect.classList.remove('is-invalid'); // Remove error styles
					        });
				
					        // Optional: Remove validation errors as user types/changes
					        editaddressInput.addEventListener('input', function() {
					            if (!isBlank(this.value)) {
					                this.classList.remove('is-invalid');
					                editaddressError.style.display = 'none';
					                editaddressError.textContent = '';
					            }
					        });
					        editprovinceSelect.addEventListener('change', function() {
					            this.classList.remove('is-invalid');
					        });
					        editdistrictSelect.addEventListener('change', function() {
					            this.classList.remove('is-invalid');
					        });
					        editwardSelect.addEventListener('change', function() {
					            this.classList.remove('is-invalid');
					        });
						});
						</script>

								<script
									th:src="@{/client/assets/js/vendors/jquery-3.6.0.min.js}"></script>
								<script>
						$(document).ready(function(){
							$('.deleteAddress').on('click',function(event){
								event.preventDefault();
								var deleteAddressId = $(this).data('address-id');
								$('#deleteAddressInput').val(deleteAddressId);
								if(deleteAddressId){
									$('#deleteAddressSubmitButton').on('click',function(){
										$('#deleteAddressForm').submit();
									});
								}
								$('#deleteAddressModal').modal('show');
							});
						});
					</script>

								<script>                                                
													$(document).ready(function() {
													    $('.changeAddress').on('click', function(event) {
													        event.preventDefault(); // Prevent default button behavior if it's a link
													
													        // Get the address ID from a data attribute
													        var editAddressId = $(this).data('address-id');
													        // Set the address ID to a hidden input field
													        document.getElementById('addAddressVariable').value = editAddressId;
													
													        if (editAddressId) {
													            $.ajax({
													                url: '/customer/api/address/geteditaddress', // Your Spring Boot endpoint URL
													                type: 'GET',
													                data: { editAddressId: editAddressId },
													                success: async function(userAddress) { // Made the success function asynchronous
													                    // Check if data is received and is not null
													                    if (userAddress) {
													                        // Populate simple input fields
													                        $('#editAddressForm input[name="name"]').val(userAddress.name);
													                        $('#editAddressForm input[name="address"]').val(userAddress.address);
																			
													                        // --- Step 1: Populate Provinces ---
													                        if (userAddress.provinces) {
													                            $('#editprovinceSelect').val(userAddress.provincesCode);
													                            $('#editprovinceSelect').trigger('change');                          
													                            console.log($('#editprovinceSelect'));
													                            // No need to trigger change here if we are programmatically fetching districts/wards
													                            // unless there's another independent listener for real-time user selection updates.
													                        }
													                        // --- Step 2: Populate Districts (after provinces are set) ---
													                        if (userAddress.districts && userAddress.provincesCode) {
													                            try {
													                                const response = await fetch(`/api/address/districts?provinceCode=${userAddress.provincesCode}`);
													                                const data = await response.json();
																					
													                              
													                                
													                                data.forEach(district => {
													                                    const option = document.createElement("option");
													                                    option.value = district.code;
													                                    option.text = district.shortName + ' ' + district.name;
													                                    editdistrictSelect.appendChild(option);
													                                });
													                                editdistrictSelect.disabled = false; // Enable the district dropdown
													                                
													                                // Set the current district value AFTER all options are loaded
													                                $('#editdistrictSelect').val(userAddress.districtsCode);                              
													                                $('#editdistrictSelect').trigger('change');
													                               // Ensure value is also set for option
													                            } catch (error) {
													                                console.error('Error fetching districts:', error);
													                            }
													                        }
													
													                        // --- Step 3: Populate Wards (after districts are set) ---
													                        // Ensure userAddress.districtsCode is used for the API call
													                        if (userAddress.wards && userAddress.districtsCode) { 
													                            try {
													                                const response = await fetch(`/api/address/wards?districtCode=${userAddress.districtsCode}`);
													                                const data = await response.json();
													
													                                const editwardSelect = document.getElementById('editwardSelect'); // Ensure this ID matches your HTML
													                                editwardSelect.innerHTML = '<option selected disabled>Ward</option>'; // Keep the default option
													                                
													                                data.forEach(ward => {
													                                    const option = document.createElement("option");
													                                    option.value = ward.code;
													                                    option.text = ward.shortName + ' ' + ward.name;
													                                    editwardSelect.appendChild(option);
													                                });
													                                editwardSelect.disabled = false; // Enable the ward dropdown
													                                
													                                // Set the current ward value AFTER all options are loaded
													                                $('#editwardSelect').val(userAddress.wardsCode);
													                                $('#editwardSelect').trigger('change');
													                                // Set the text for a display element, if it exists
													                                // Ensure value is also set for option
													                            } catch (error) {
													                                console.error('Error fetching wards:', error);
													                            }
													                        }
													
													                        // Show the modal after all dropdowns are potentially populated
													                        $('#editAddressModal').modal('show');
													                         
													                        // Handle hidden ID input for form submission
													                        if ($('#addAddressForm input[name="id"]').length === 0) { // Check if an ID input already exists
													                            $('#addAddressForm').prepend('<input type="hidden" name="id" value="' + userAddress.id + '">');
													                        } else {
													                            $('#addAddressForm input[name="id"]').val(userAddress.id);
													                        }
													
													                    } else {
													                        console.error('No address data received.');
													                        // Use a custom message box instead of alert()
													                        // You would need to implement a custom modal or div for this.
													                        // For demonstration, a console log is used.
													                        console.log('Error: Could not retrieve address data.'); 
													                    }
													                },
													                error: function(xhr, status, error) {
													                    console.error("AJAX Error:", status, error);
													                    // Use a custom message box instead of alert()
													                    console.log('Error loading address for editing. Please try again.');
													                }
													            });
													        } else {
													            console.error("No address ID found for editing.");
													            // Use a custom message box instead of alert()
													            console.log('Cannot edit address: No ID provided.');
													        }
													    });
													});
													</script>

								<th:block th:each="userAdress, i : ${userAdresses}">
									<div th:if="${userAdress.deletedAt == null}"
										class="card mb-2 card-clickable" style="padding: 0;">
										<div class="card-body bg-light">
											<article class="box mb-3 bg-light">
												<a class="btn btn-cart w-auto float-end changeAddress"
													th:data-address-id="${userAdress.id}">Change</a> <a
													class="float-end" href="#">&nbsp;&nbsp;&nbsp;</a> <a
													class="btn btn-cart-delete w-auto float-end deleteAddress"
													th:data-address-id="${userAdress.id}">Delete</a>
												<h6 th:text="${userAdress.name}"></h6>
												<small class="text-muted d-block" style="width: 70%">
													<th:block
														th:text="${userAdress.address}+' '+${userAdress.wards.administrativeUnits.shortName}+' '+${userAdress.wards.name}+' '+${userAdress.districts.administrativeUnits.shortName}+' '+${userAdress.districts.name}+' '+${userAdress.provinces.administrativeUnits.shortName}+' '+${userAdress.provinces.name}"></th:block>
												</small>
											</article>
										</div>
									</div>
								</th:block>
							</div>
						</div>

					</div>
					<div class="col-lg-6">
						<div class="box-border">
							<div class="border-bottom-4 text-center mb-35">
								<div class="text-or font-md color-gray-500">
									<h5 class="font-md-bold color-brand-3">Your order</h5>
								</div>
							</div>
							<div class="listCheckout">
								<div class="box-orders"
									th:each="vendorItems : ${groupedCheckoutList}">
									<div class="head-orders">
										<div class="head-left" style="width: 10%">
											<h5 style="margin-left: 4%">
												<a th:text="${vendorItems.key.name}"></a>
											</h5>
										</div>
									</div>
									<div class="body-orders">
										<div class="list-orders">

											<div class="item-wishlist"
												th:each="item : ${vendorItems.value}">
												<div class="wishlist-product">
													<div class="product-wishlist">
														<div class="product-image">
															<input class="cartItemId" type="hidden" th:value="${item.cartItem.id}" />
															<a href="shop-single-product.html"> <th:block
																	th:if="${item.cartItem.products.mediases[0].name.contains('https:')}">
																	<img
																		th:src="${item.cartItem.products.mediases[0].name}"
																		alt="Ecom">
																</th:block> <th:block
																	th:if="${!item.cartItem.products.mediases[0].name.contains('https:')}">
																	<img
																		th:src="@{'/assets/imgs/items/' + ${item.cartItem.products.mediases[0].name}}"
																		alt="Ecom">
																</th:block>

															</a>
														</div>
														<div class="product-info">
															<a href="shop-single-product.html">
																<h6 class="color-brand-3"
																	th:text="${item.cartItem.products.name} + ' ' + ${item.combination}"></h6>
															</a>
															<div class="rating"></div>
														</div>
													</div>
												</div>
												<div class="wishlist-status">
													<h5 class="color-gray-500">
														x
														<th:block th:text="${item.cartItem.quantity}"></th:block>
													</h5>
												</div>
												<div class="wishlist-price">
													<th:block th:if="${item.hasDiscount}">
														<h5 class="color-brand-3">
															$
															<th:block
																th:text="${item.afterDiscountPrice * item.cartItem.quantity}"></th:block>
														</h5>
													</th:block>
													<th:block th:if="${!item.hasDiscount}">
														<h5 class="color-brand-3">
															$
															<th:block
																th:text="${item.originalPrice * item.cartItem.quantity}"></th:block>
														</h5>
													</th:block>
												</div>
											</div>

										</div>
									</div>
									<!-- choose voucher -->
									<div class="form-group d-flex mx-4">
										<div class="input-group">
											<input type="text" class="form-control" th:id="'chooseVoucherInput_'+${vendorItems.key.id}"
												placeholder="Choose Your Voucher" readonly="readonly">
											<div class="input-group-append">
												<button th:id="'chooseVoucherButton_'+${vendorItems.key.id}"
													class="btn btn-buy" type="button">Apply</button>
											</div>
										</div>
									</div>
									<script>
									var vendorMap = new Map();
									var voucherIdMap = new Map();
									
								$(document).ready(function() {
								
									
									$(document).on('click','#chooseVoucherButton_[[${vendorItems.key.id}]]',function(event){
										var vendorId = $(this).attr('id').split('_')[1];
										
										$('#chooseVoucherModal_[[${vendorItems.key.id}]]').modal('show');
									});
									$(document).on('click','#saveVoucher_[[${vendorItems.key.id}]]',function(){
										var $modal = $(this).closest('.modal');
								        var modalId = $modal.attr('id');
								        var vendorId = modalId.split('_')[1];
								        const $selectedVoucherInput = $modal.find('input[name="voucherForVendor_' + vendorId + '"]:checked');
								        if ($selectedVoucherInput.length > 0) {
								        	var voucherId = $selectedVoucherInput.attr('id').split('_')[1];
								        	var userId = '[[${user.id}]]';
								        	var cartItemsIdses = $('#cartItems').val();
								           fetch('/customer/cart/apply-voucher', { 
										        method: 'POST',
										        headers: {
										            'Content-Type': 'application/json',
										        },
										        body: JSON.stringify({
										            vendorId: vendorId,
										            voucherId: voucherId,
										            userId: userId,
										            cartItemsIdses: cartItemsIdses
										        }),
										    })
										    .then(response => response.json())
										    .then(data => {
										        if (data.success) {
										        	var voucherIdArray = [];
										            var discount = 0;
										            vendorMap.set('[[${vendorItems.key.id}]]',data.discountAmount);
										            voucherIdMap.set('[[${vendorItems.key.id}]]',voucherId);
										            
										            
										            for(var voucher of voucherIdMap.values()){
										            	voucherIdArray = voucherIdArray.concat(voucher);
										            }
										            $('#vouchers').val(voucherIdArray.join(','))
										            console.log($('#vouchers').val());
										            for(var amount of vendorMap.values()){
										            	discount += parseFloat(amount);
										            }
										        	$('#subTotalText').html(discount.toFixed(2));
										        	updateTotal();
										    		$('#chooseVoucherModal_[[${vendorItems.key.id}]]').modal('hide');
										    		
										            
										        } else {
										            alert('Áp dụng voucher thất bại: ' + data.message);
										        }
										    })
										    .catch((error) => {
										        console.error('Lỗi khi gửi yêu cầu:', error);
										        alert('Đã xảy ra lỗi khi áp dụng voucher.');
										    });      	
								        }
									});
								
								});
							</script>
									<div class="modal fade"
										th:id="'chooseVoucherModal_'+${vendorItems.key.id}"
										tabindex="-1" aria-labelledby="chooseVoucherModal"
										aria-hidden="true">
										<div class="modal-dialog">										
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title fs-5" id="exampleModalLabel">Your
														voucher</h1>
													<button type="button" class="btn-close"
														data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<th:block
														th:each="voucherByVendors : ${voucherByVendorList}">
														<th:block
															th:if="${voucherByVendors.key == vendorItems.key.id}">
															<th:block
																th:each="voucherByVendor : ${voucherByVendors.value}">
																<div class="form-check mb-3 p-3 border rounded bg-light">
																
																	<input class="form-check-input" type="radio"
																		th:id="'voucherRadio_'+${voucherByVendor.id}"
																		th:name="'voucherForVendor_'+${vendorItems.key.id}"
																		value="unselected"> <label
																		class="form-check-label w-100 voucherIds"
																		th:data-voucher-radio-vendor="'voucherByVendor_'+${voucherByVendors.key}"
																		th:for="'voucherRadio_'+${voucherByVendor.id}">
																		<div
																			class="d-flex justify-content-between align-items-center">
																			<h5 class="mb-0">

																				<span> Voucher discount </span> <span
																					th:text="${voucherByVendor.discountUnit eq 'money' ? '$' : ''}"></span>
																				<span th:text="${voucherByVendor.discountValue}"
																					th:if="${voucherByVendor.discountUnit eq 'money'}"></span>
																				<span
																					th:text="${#numbers.formatDecimal(voucherByVendor.discountValue*100, 0, 0)}"
																					th:if="${voucherByVendor.discountUnit eq 'percent'}"></span>
																				<span
																					th:text="${voucherByVendor.discountUnit eq 'percent' ? '%' : ''}"></span>
																				<span> maximum $</span> <span
																					th:text="${voucherByVendor.maxDiscountAmount}"></span>
																				<span> for order at least $</span> <span
																					th:text="${voucherByVendor.minOrderValue}"></span>

																			</h5>

																		</div>
																		<p class="text-muted mb-1 mt-2"
																			style="font-size: 15px; color: black;">
																			Valid: <span
																				th:text="${#dates.format(voucherByVendor.startTime, 'dd/MM/yyyy')}"></span>
																			- <span
																				th:text="${#dates.format(voucherByVendor.endTime, 'dd/MM/yyyy')}"></span>
																		</p>
																	</label>
																</div>
															</th:block>
															<div class="text-center p-4"
																th:if="${#lists.isEmpty(voucherByVendors.value)}">
																<p class="text-muted">No vouchers available at the
																	moment.</p>
															</div>
														</th:block>
													</th:block>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-cart-delete w-auto"
														data-bs-dismiss="modal">Close</button>
													<button type="button" class="btn btn-cart w-auto"
														th:id="'saveVoucher_'+${vendorItems.key.id}">Save changes</button>
												</div>
											</div>
										</div>
									</div>
								</div>

							</div>

							<div class="form-group mb-0">
								<div class="row mb-10"  >
									<div class="col-lg-6 col-6" >
										<span class="font-md-bold color-brand-3">Subtotal</span>
									</div>
									<div class="col-lg-6 col-6 text-end d-flex justify-content-end">
										<span class="font-lg-bold color-brand-3">$</span>
										<div class="font-lg-bold color-brand-3" th:text="${#numbers.formatDecimal(subTotal, 0, 'COMMA', 2, 'POINT')}"></div>
									</div>
									<div class="col-lg-6 col-6" >
										<span class="font-md-bold color-brand-3">&nbsp;</span>
									</div>
									<div class="col-lg-6 col-6 text-end d-flex justify-content-end">
										<span class="font-lg-bold color-brand-3">-$</span>
										<div class="font-lg-bold color-brand-3" id="subTotalText">0</div>
									</div>

								</div>
								<div class="form-group mb-0">
									<div class="row mb-10">
										<div class="col-lg-6 col-6">
											<span class="font-md-bold color-brand-3">Shipping</span>
										</div>
										<div
											class="col-lg-6 col-6 text-end d-flex justify-content-end">
											<span class="font-lg-bold color-brand-3">$</span>
											<div id="shipping"class="font-lg-bold color-brand-3"></div>
										</div>
									</div>
									<!-- choose voucher total -->
									<div class="border-bottom mb-10 pb-5">
										<div class="input-group">
											<input type="text" class="form-control"
												placeholder="Choose Your Voucher" readonly="readonly">
											<div class="input-group-append">
												<button th:id="'chooseVoucherButtonTotal'"
													class="btn btn-buy" type="button">Apply</button>
											</div>
										</div>
									</div>
									<script>
									function updateTotal(){
										var total = parseFloat('[[${subTotal}]]');
											console.log('begin Total: '+total);
										if($('#subTotalText').text() != '0'){
											total -= parseFloat($('#subTotalText').text());
										}
										if($('#totalDiscountAmount').text() != '0'){
											total -= parseFloat($('#totalDiscountAmount').text());
										}
										$('#total').html((total + parseFloat($('#shipping').val())).toFixed(2));
										$('#orderTotal').val((total + parseFloat($('#shipping').val())).toFixed(2));
									}
									function updateTotalVoucher(){
								        const selectedVoucherId = $('input[name="voucherForEventura"]:checked').attr('id').split('_')[1];
								        const currentTotal = parseFloat($('#total').text());
								        if (selectedVoucherId) {  
									        $.ajax({
									                url: '/customer/cart/apply-total-voucher', // **CHANGE THIS TO YOUR ACTUAL ENDPOINT**
									                type: 'POST',
									                contentType: 'application/json', // <--- ADD THIS LINE
									                data: JSON.stringify({ // <--- STRINGIFY YOUR DATA TO JSON
									                    voucherId: selectedVoucherId,
									                    currentTotal: currentTotal
									                }),
									                success: function(response) {
									                    if (response.success) {
									                     	console.log(response.discountAmount);
															$('#totalDiscountAmount').text(response.discountAmount.toFixed(2));
															$('#voucherEventura').val(selectedVoucherId);
															console.log($('#voucherEventura').val());
															updateTotal();
									                        $('#chooseVoucherModalTotal').modal('hide'); // Hide the modal on success
									                    } else {
									                        alert('Error applying voucher: ' + response.message);
									                    }
									                },
									                error: function(xhr, status, error) {
									                    console.error('AJAX Error:', status, error);
									                    alert('An error occurred while applying the voucher. Please try again.');
									                }
									            });
								        } else {
								            alert('Please select a voucher.');
								        }
									}
									
									$(document).on('click','#chooseVoucherButtonTotal',function(event){
								        $('#chooseVoucherModalTotal').modal('show');
								    });

								    $(document).on('click', '#voucherTotalButton', function(event) {
								    	
								        	updateTotalVoucher();
								         
								    });
									</script>
									<div class="modal fade" th:id="chooseVoucherModalTotal"
										tabindex="-1" aria-labelledby="chooseVoucherModalTotal"
										aria-hidden="true">
										<div class="modal-dialog">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title fs-5" id="exampleModalLabel">Your
														voucher</h1>
													<button type="button" class="btn-close"
														data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">

													<th:block th:each="voucherTotal : ${voucherByEventura}">

														<div class="form-check mb-3 p-3 border rounded bg-light">
															<input class="form-check-input" type="radio"
																th:id="'voucherRadio_'+${voucherTotal.id}"
																name="voucherForEventura"
																value="unselected"> <label
																class="form-check-label w-100"
																th:for="'voucherRadio_'+${voucherTotal.id}">
																<div
																	class="d-flex justify-content-between align-items-center">
																	<h5 class="mb-0">

																		<span> Voucher discount </span> <span
																			th:text="${voucherTotal.discountUnit eq 'money' ? '$' : ''}"></span>
																		<span th:text="${voucherTotal.discountValue}"
																			th:if="${voucherTotal.discountUnit eq 'money'}"></span>
																		<span
																			th:text="${#numbers.formatDecimal(voucherTotal.discountValue*100, 0, 0)}"
																			th:if="${voucherTotal.discountUnit eq 'percent'}"></span>
																		<span
																			th:text="${voucherTotal.discountUnit eq 'percent' ? '%' : ''}"></span>
																		<span> maximum $</span> <span
																			th:text="${voucherTotal.maxDiscountAmount}"></span> <span>
																			for order at least $</span> <span
																			th:text="${voucherTotal.minOrderValue}"></span>

																	</h5>

																</div>

																<p class="text-muted mb-1 mt-2"
																	style="font-size: 15px; color: black;">
																	Valid: <span
																		th:text="${#dates.format(voucherTotal.startTime, 'dd/MM/yyyy')}"></span>
																	- <span
																		th:text="${#dates.format(voucherTotal.endTime, 'dd/MM/yyyy')}"></span>
																</p>
															</label>
														</div>
													</th:block>
													<div class="text-center p-4"
														th:if="${#lists.isEmpty(voucherByEventura)}">
														<p class="text-muted">No vouchers available at the
															moment.</p>
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-cart-delete w-auto"
														data-bs-dismiss="modal">Close</button>
													<button type="button" class="btn btn-cart w-auto"
														id="voucherTotalButton">Save changes</button>
												</div>
											</div>
										</div>
									</div>
									<div class="row">
									<div class="col-lg-6 col-6">
											<span class="font-md-bold color-brand-3">&nbsp;</span>
										</div>
										<div class="col-lg-6 col-6 text-end d-flex justify-content-end">
											<span class="font-lg-bold color-brand-3">-$</span>
											<h4 id="totalDiscountAmount" class="font-lg-bold color-brand-3">0</h4>
										</div>
										<div class="col-lg-6 col-6">
											<span class="font-md-bold color-brand-3">Total</span>
										</div>
										<div class="col-lg-6 col-6 text-end d-flex justify-content-end">
											<span class="font-lg-bold color-brand-3">$</span>
											<h4 id="total" class="font-lg-bold color-brand-3" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 2, 'POINT')}"></h4>
										</div>
										
									</div>
								</div>
							</div>
							<form id="placeanorderForm" method="post" th:action="@{/customer/cart/process-checkout}">		
								<input id="newOrderPaymentMethod" type="hidden" th:field="${newOrder.paymentMethod}">						
								<input id="newOrderAddress" type="hidden" th:field="${newOrder.userAddress}">						
													
								<input id="orderTotal" type="hidden" th:field="${newOrder.totalAmount}">						
								<input id="cartItems" type="hidden"	name="cartItems"/>				
								<input id="vouchers" type="hidden" name="vouchers"/>				
								<input id="voucherEventura" type="hidden" name="voucherEventura"/>				
								<div class="row mt-20">
									<div class="col-lg-6 col-7 mb-20 text-end">&nbsp;</div>
									<div class="col-lg-6 col-7 mb-20 text-end">
										<button class="btn btn-buy w-auto arrow-next" id="placeanorder"
											type="button">Place an Order</button>
									</div>
								</div>
							</form>
							<div class="container" hidden>
						            <input type="text" id="startAddress" placeholder="Ví dụ: 123 Đường ABC, Quận 1, TP.HCM" value="Nhà thờ Đức Bà Sài Gòn">
						            <input type="text" id="endAddress" placeholder="Ví dụ: 456 Đường XYZ, Quận 5, TP.HCM" value="Chợ Bến Thành">
						        <button onclick="calculateDistance()">Tính Khoảng Cách</button>
						
						        <p id="result">Nhập địa chỉ và nhấn "Tính Khoảng Cách"</p>
						    </div>
														
						</div>
					</div>
				</div>
				<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
				<script>
				  // THAY THẾ 'YOUR_OPENCAGE_API_KEY' BẰNG API KEY THỰC CỦA BẠN TẠI ĐÂY
				  
		        const OPENCAGE_API_KEY = '3ec3c746f9d6482f8caf078f7056c875';
		
		        // Hàm chuyển đổi tên địa điểm thành tọa độ (kinh độ, vĩ độ) sử dụng OpenCage
		        async function geocode(locationName) {
		            // URL của OpenCage API. Thay thế YOUR_OPENCAGE_API_KEY bằng khóa API của bạn.
		            const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(locationName)}&key=${OPENCAGE_API_KEY}&limit=1&no_annotations=1&language=vi`;
		            try {
		                const response = await fetch(url);
		                if (!response.ok) {
		                    // Xử lý lỗi HTTP từ API
		                    const errorData = await response.json();
		                    console.error(`OpenCage API returned an error: ${response.status} ${response.statusText}`, errorData);
		                    return null;
		                }
		                const data = await response.json();
		
		                // Kiểm tra xem có kết quả nào không và truy cập dữ liệu tọa độ
		                if (data && data.results && data.results.length > 0) {
		                    const firstResult = data.results[0].geometry;
		                    return { lat: firstResult.lat, lon: firstResult.lng }; // OpenCage trả về lng cho kinh độ
		                }
		            } catch (error) {
		                console.error('Lỗi khi chuyển đổi địa điểm (geocode với OpenCage):', error);
		            }
		            return null; // Trả về null nếu không tìm thấy hoặc có lỗi
		        }
		
		        // Hàm chính để tính toán khoảng cách (không thay đổi phần này)
		        async function calculateDistance() {
		            const startAddress = '35/6 Đường D5, Phường 25, Bình Thạnh, Hồ Chí Minh 72308, Việt Nam';
		            const endAddress = document.getElementById('endAddress').value.trim();
		            const resultElement = document.getElementById('result');
		
		            if (!startAddress || !endAddress) {
		                resultElement.textContent = 'Vui lòng nhập đầy đủ cả hai địa chỉ.';
		                resultElement.classList.add('error');
		                return;
		            }
		
		            resultElement.textContent = 'Đang tính toán...';
		            resultElement.classList.remove('error'); // Remove error class if previously set
		
		            try {
		                // Bước 1: Geocoding - Chuyển đổi địa chỉ thành tọa độ
		                const startCoords = await geocode(startAddress);
		                const endCoords = await geocode(endAddress);
		
		                if (!startCoords) {
		                    resultElement.textContent = `Không tìm thấy tọa độ cho địa chỉ bắt đầu: "${startAddress}". Vui lòng nhập địa chỉ cụ thể hơn hoặc kiểm tra chính tả.`;
		                    resultElement.classList.add('error');
		                    return;
		                }
		                if (!endCoords) {
		                    resultElement.textContent = `Không tìm thấy tọa độ cho địa chỉ kết thúc: "${endAddress}". Vui lòng nhập địa chỉ cụ thể hơn hoặc kiểm tra chính tả.`;
		                    resultElement.classList.add('error');
		                    return;
		                }
		
		                // Bước 2: Gọi API định tuyến OSRM để lấy khoảng cách (vẫn giữ nguyên OSRM)
		                // Định dạng tọa độ cho OSRM là kinh độ,vĩ độ
		                const startLngLat = `${startCoords.lon},${startCoords.lat}`;
		                const endLngLat = `${endCoords.lon},${endCoords.lat}`;
		
		                // Sử dụng profile 'driving' cho ô tô. overview=false để không lấy chi tiết tuyến đường.
		                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${startLngLat};${endLngLat}?overview=false`;
		
		                const osrmResponse = await fetch(osrmUrl);
		                const osrmData = await osrmResponse.json();
		
		                if (osrmData.code === 'Ok' && osrmData.routes.length > 0) {
		                    const distanceMeters = osrmData.routes[0].distance; // Khoảng cách tính bằng mét
		                    const durationSeconds = osrmData.routes[0].duration; // Thời gian tính bằng giây
		
		                    const distanceKm = (distanceMeters / 1000).toFixed(2); // Chuyển đổi sang km và làm tròn 2 chữ số thập phân
		                    const durationMinutes = (durationSeconds / 60).toFixed(0); // Chuyển đổi sang phút và làm tròn
		                    $('#shipping').val((0.2*distanceKm).toFixed(2));
		                    $('#shipping').text((0.2*distanceKm).toFixed(2));
		                    updateTotal();
		                    resultElement.textContent = `Khoảng cách ước tính: ${distanceKm} km. Thời gian di chuyển ước tính: ${durationMinutes} phút.`;
		                } else {
		                    resultElement.textContent = 'Không tìm thấy tuyến đường giữa hai địa chỉ này. Vui lòng kiểm tra lại địa chỉ và đảm bảo chúng có thể tiếp cận được bằng đường bộ.';
		                    resultElement.classList.add('error');
		                    console.error('Lỗi từ OSRM:', osrmData.code, osrmData.message);
		                }
		            } catch (error) {
		                resultElement.textContent = 'Có lỗi xảy ra khi tính toán khoảng cách. Vui lòng thử lại.';
		                resultElement.classList.add('error');
		                console.error('Lỗi tổng quát:', error);
		            }
		        }

					$(document).ready(async function(){
						
						//Map
						// Hàm chuyển đổi tên địa điểm thành tọa độ (kinh độ, vĩ độ)
				        var newOrderAddress = $('#newOrderAddress').val();
						console.log(newOrderAddress);
				        $('#endAddress').val(newOrderAddress);
				        await calculateDistance();
						//paypal
						var cartItemIds = []; 												
						$('.cartItemId').each(function() {
							cartItemIds.push($(this).val());						    
						});
						
						$('#cartItems').val(cartItemIds.join(','));
						$('#orderTotal').val('[[${total}]]');
						$('.card-clickable:first').addClass('onselected-checkout');
						$('.payment-clickable').on('click',function(){
							
					        $('.payment-clickable').removeClass('onselected-checkout');

					        $(this).addClass('onselected-checkout');
					        var selectedId = $('.payment-clickable.onselected-checkout').attr('id').split('-')[1];
					        if(selectedId == 'cod'){
					        	$('#newOrderPaymentMethod').val('COD');
					        } else if (selectedId == 'paypal'){
					        	$('#newOrderPaymentMethod').val('PAYPAL');				        	
					        }
						});
						$('.card-clickable').on('click',async function(){
							
					        $('.card-clickable').removeClass('onselected-checkout');
					        $(this).addClass('onselected-checkout');
					        const addressText = $(this).find('small').text().trim();
					        
					        $('#endAddress').val(addressText);
					        $('#endAddress').text(addressText);
					       
					        await calculateDistance();
						});
						$('#placeanorder').on('click',async function(){
							var selectedId = $('.payment-clickable.onselected-checkout').attr('id').split('-')[1];
							if(selectedId == 'cod'){
								$('#placeanorderForm').submit();
							} else if(selectedId == 'paypal'){
								var amount = $('#total').text();
								var cartItemsValue = $('#cartItems').val();
								var vouchersValue = $('#vouchers').val();
								var voucherEventuraValue = $('#voucherEventura').val();
								var userIdValue = '[[${user.id}]]';
								console.log("id value:" + userIdValue);
								let newOrder = {
									paymentMethod: $('#newOrderPaymentMethod').val(),
									totalAmount: $('#orderTotal').val(),
									userAddress: $('#newOrderAddress').val()
								} 
								try {
									let response = await fetch("/paypal/pay?amount=" + amount +"&cartItems="+cartItemsValue+"&vouchers="+vouchersValue+"&voucherEventura="+voucherEventuraValue+"&userId="+userIdValue, { // Corrected URL here
						                method: "POST",
						                headers: {
						                    "Content-Type": "application/json" // Very important!
						                },
						                body: JSON.stringify(newOrder)	
						            });

						            let result = await response.text();
						            
						            if (result.includes("Redirect to:")) {
						                let url = result.replace("Redirect to: ", "").trim();
						                $('#placeanorderForm').submit();
						                window.location.href = url; // Redirect to PayPal						                
						            }

						        } catch (error) {
						            console.error("Error:", error);
						           
						        }
							}
						});
					});
				</script>
		</section>
		<section class="section-box mt-90 mb-50">
			<div class="container">
				<ul class="list-col-5">
					<li>
						<div class="item-list">
							<div class="icon-left">
								<img th:src="@{/assets/imgs/template/delivery.svg}" alt="Ecom">
							</div>
							<div class="info-right">
								<h5 class="font-lg-bold color-gray-100">Free Delivery</h5>
								<p class="font-sm color-gray-500">From all orders over $10</p>
							</div>
						</div>
					</li>
					<li>
						<div class="item-list">
							<div class="icon-left">
								<img th:src="@{/assets/imgs/template/support.svg}" alt="Ecom">
							</div>
							<div class="info-right">
								<h5 class="font-lg-bold color-gray-100">Support 24/7</h5>
								<p class="font-sm color-gray-500">Shop with an expert</p>
							</div>
						</div>
					</li>
					<li>
						<div class="item-list">
							<div class="icon-left">
								<img th:src="@{/assets/imgs/template/voucher.svg}" alt="Ecom">
							</div>
							<div class="info-right">
								<h5 class="font-lg-bold color-gray-100">Gift voucher</h5>
								<p class="font-sm color-gray-500">Refer a friend</p>
							</div>
						</div>
					</li>
					<li>
						<div class="item-list">
							<div class="icon-left">
								<img th:src="@{/assets/imgs/template/return.svg}" alt="Ecom">
							</div>
							<div class="info-right">
								<h5 class="font-lg-bold color-gray-100">Return &amp; Refund</h5>
								<p class="font-sm color-gray-500">Free return over $200</p>
							</div>
						</div>
					</li>
					<li>
						<div class="item-list">
							<div class="icon-left">
								<img th:src="@{/assets/imgs/template/secure.svg}" alt="Ecom">
							</div>
							<div class="info-right">
								<h5 class="font-lg-bold color-gray-100">Secure payment</h5>
								<p class="font-sm color-gray-500">100% Protected</p>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</section>
	</main>

</body>